# Rust PerfBlock
Rust rewrite of the venerable <https://github.com/viktorleis/perfevent> with some rust-specific niceties and improvements.

## Usage

Usage similar to the C++ API:
```rust
let mut params = BenchmarkParameters::default();
params.set("query", "Q1"); // additional columns in output
let events_to_track = Events::default();
{ // scope measured
  let perf = PerfEventBlock::new(/*scale=*/100, events_to_track, params, /*print_header=*/true)?;
  expensive_function()
  // perf drop()ed here, stats computed & printed to stdout 
}
```

Output (counters are normalized by `scale`):
``` csv
query, cycles, instructions, L1-misses, LLC-misses, branch-misses, task-clock,    scale,  IPC, CPUs,  GHz,
   Q1,  10.97,        28.01,      0.22,       0.00,          0.00,       3.89,      100, 2.55, 1.00, 2.82,
```

Lambda-based usage:
``` rust
use perfblock::*;
PerfEventBlock::default_params(1000*1000*, true).measure(|p: &mut PerfEventBlock| {
    let mut res = 1;
    for i in 1..(p.scale()) {
        // std::hint::black_box re-exported for convenience
        p.black_box(res += i);
    }
    p.param("res", res.to_string());
});
```

Manual Usage:
``` rust
use perfblock::*;
PerfEventBlock::default_params(1000*1000*, true).measure(|p: &mut PerfEventBlock| {
    let mut res = 1;
    for i in 1..(p.scale()) {
        // std::hint::black_box re-exported for convenience
        p.black_box(res += i);
    }
    p.param("res", res.to_string());
});
```


## Tests
Use `cargo test -- --nocapture` to show the perfevent output generated by the included tests. 

## Troubleshooting

### Bogus counter values
1. Make sure the tested code block runs long enough (> 1 sec) for the results to make sense.
2. Make sure there is only one PerfEventBlock instance active at a time: no nesting, not many across many threads
3. If you're measuring a multi-threaded program, start the `PerfEvent` instance before starting the threads

### Error while opening counters
Make sure that you have the privileges necessary to use `perf_event` on linux.
```sh
sudo sysctl -w kernel.kptr_restrict=0
sudo sysctl -w kernel.perf_event_paranoid=-1
```
